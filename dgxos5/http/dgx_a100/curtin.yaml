install:
  log_file: /var/log/curtin.log
  error_tarfile: /var/log/curtin/curtin-error-logs.tar
  post_files:
    - /var/log/curtin.log
    - /var/log/syslog
  save_install_config: /var/log/curtin-conf.yaml
  save_install_log: /var/log/curtin-install.log
  umount: disabled

sources:
  05_primary:
    uri: "file:///curtin/ubuntu-20.04-server-cloudimg-amd64-root.tar.xz"
    type: "tgz"

write_files:
  CHANGE_PLATFORM-release:
    path: /etc/CHANGE_PLATFORM-release
    content: |
      CHANGE_UPPER_PLATFORM_NAME="CHANGE_UPPER_PLATFORM Server"
      CHANGE_UPPER_PLATFORM_PRETTY_NAME="NVIDIA CHANGE_UPPER_PLATFORM Server"
      CHANGE_UPPER_PLATFORM_SWBUILD_DATE="CHANGE_TIMESTAMP"
      CHANGE_UPPER_PLATFORM_SWBUILD_VERSION="CHANGE_VERSION"
      CHANGE_UPPER_PLATFORM_COMMIT_ID="CHANGE_COMMIT_ID"
      CHANGE_UPPER_PLATFORM_PLATFORM="CHANGE_DESC_PLATFORM"
      CHANGE_UPPER_PLATFORM_SERIAL_NUMBER="CHANGE_SERIAL_NUMBER"

reporting:
  mylistener:
    type: journald
    identifier: "curtin-journald"
    level: DEBUG

# Run a subset of stages since we don't need a full install
stages: ["early", "partitioning", "network", "extract", "late"]

early_commands:
  # stop the SSH server daemon so Packer can't connect yet
  10_stop_ssh: ["systemctl", "stop", "ssh"]

late_commands:
  # SSH is configured differently in the cloud images so reconfigure it here to get back
  # to the default settings
  # DISABLED: Packer needs specific SSH settings and MAAS will overwrite these settings during deployment
  #10_conf_ssh: ["curtin", "in-target", "--", "sh", "-c", "dpkg-reconfigure openssh-server"]
  #11_conf_ssh: ["curtin", "in-target", "--", "sh", "-c", "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config"]

  # Skip writing to PLAT-release file on install
  12_conf_ssh: ["curtin", "in-target", "--", "sh", "-c", "touch /tmp/ota_skip_write"]

  22_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb [trusted=yes] http://127.0.0.1/ / > /etc/apt/sources.list"]
  23_apt_update: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt-get update -y"]
  24_install_pkgs: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' install --no-install-recommends CHANGE_INSTALL_PKGS"]
  25_unattended_upgrades: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt-get purge -y unattended-upgrades"]

  # Rewrite sources list
  # DISABLED: MAAS will overwrite these
  #30_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://us.archive.ubuntu.com/ubuntu/ CHANGE_DISTRO main restricted universe multiverse > /etc/apt/sources.list"]
  #31_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://us.archive.ubuntu.com/ubuntu/ CHANGE_DISTRO-updates main restricted universe multiverse >> /etc/apt/sources.list"]
  #32_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://security.ubuntu.com/ubuntu/ CHANGE_DISTRO-security main restricted universe multiverse >> /etc/apt/sources.list"]

  # [bug 3099036]: create auth.log now so the fail2ban service can start
  33_touch_auth: ["curtin", "in-target", "--", "sh", "-c", "sudo -u syslog -g adm touch /var/log/auth.log && chmod 644 /var/log/auth.log || true"]

  # Disable release-upgrade prompt
  40_disable_upgrade: ["curtin", "in-target", "--", "sh", "-c", "sed -i -e 's/^Prompt=.*/Prompt=never/' /etc/update-manager/release-upgrades"]

  # Load ipmi_devintf
  41_ipmi_devintf: ["curtin", "in-target", "--", "sh", "-c", "echo ipmi_devintf >> /etc/modules"]
  42_openibd: ["curtin", "in-target", "--", "sh", "-c", "systemctl enable openibd.service"]

  # This next line must be split across two lines or the sed search replace will not work
  43_nv_peer_mem: ["curtin", "in-target", "--", "sh", "-c",
    "/usr/sbin/update-rc.d nv_peer_mem defaults"]

  # DISABLED: no MLNX cards in packer env
  #44_mlnx_pxe: ["curtin", "in-target", "--", "sh", "-c", "mlnx_pxe_setup.bash"]

  # Enable fabric manager service
  45_enable_fm: ["curtin", "in-target", "--", "sh", "-c", "systemctl enable nvidia-fabricmanager.service"]

  # Disable SRP
  46_disable_srp: ["curtin", "in-target", "--", "sh", "-c", "systemctl disable srp_daemon.service"]
  47_disable_srp_tools: ["curtin", "in-target", "--", "sh", "-c", "systemctl disable srptools.service"]
  48_disable_rshim: ["curtin", "in-target", "--", "sh", "-c",
    "if ! lspci | grep -qi bluefield; then \
       systemctl disable rshim.service; \
     fi"]
  49_enable_dcgm: ["curtin", "in-target", "--", "sh", "-c", "systemctl enable dcgm.service"]
  50_enable_nvpm: ["curtin", "in-target", "--", "sh", "-c", "systemctl enable nvidia-persistenced.service"]

  # RAID
  # DISABLED: MAAS manages disk layout

  # Disable ipmisol if encrypting or else the cryptpass prompt only appears
  # on the SOL interface
  53_unset_ipmisol: ["curtin", "in-target", "--", "sh", "-c",
    "if CHANGE_IPMISOL; then \
       if [ -f /etc/default/grub.d/ipmisol.cfg ]; then \
         sed -i 's/^/#/' /etc/default/grub.d/ipmisol.cfg; \
         update-grub; \
       fi \
     fi"]

  # Copy logs from the install environment into the target
  90_mkdir_installer_logs: mkdir -p $TARGET_MOUNT_POINT/var/log/installer
  91_copy_logs: cp -rf /var/log/* $TARGET_MOUNT_POINT/var/log/installer/

  # Replicate boot partition
  # DISABLED: not applicable in Packer; MAAS handles disk layout

  # Prepare oem-config
  98_disable_tasksel: ["curtin", "in-target", "--", "sh", "-c",
    "if [ -f /usr/share/tasksel/descs/ubuntu-tasks.desc ]; then \
       echo > /usr/share/tasksel/descs/ubuntu-tasks.desc; \
     fi"]
  99_oem_config_prepare: ["curtin", "in-target", "--", "sh", "-c", "oem-config-prepare --quiet"]

  # Enable SSH last when using Packer
  90_conf_ssh: ["sed", "-i", "s/PasswordAuthentication no/PasswordAuthentication yes/", "/etc/ssh/sshd_config"]
  91_conf_ssh: ["sed", "-i", "s/#PermitRootLogin prohibit-password/PermitRootLogin yes/", "/etc/ssh/sshd_config"]
  92_set_root_pw: ["sh", "-c", "echo root:root | chpasswd"]
  93_start_ssh: ["systemctl", "start", "ssh"]

  # Sleep just in case so Packer has a chance to shut down the machine vs the init script ending
  # This won't actually run for 600 seconds
  94_sleep: ["sleep", "600"]
